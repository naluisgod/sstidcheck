<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SCHIRRER SCHONS & TRITSCHLER - ID verification</title>
  <meta name="description" content="Upload the front and back of an ID card, read the MRZ, and send to SSTLaw." />
  <style>
    :root{
      --brand-blue:#23568d;
      --brand-orange:#ef8d53;
      --text:#0b1220;
      --muted:#475569;
      --border:#e5e7eb;
      --bg:#f7f8fb;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
    header{background:#fff;color:var(--brand-blue);padding:20px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border)}
    header img{height:42px}
    header h1{margin:0;font-size:22px}
    main{max-width:980px;margin:28px auto;padding:0 16px}
    .card{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:18px 18px 12px;margin-bottom:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .row-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    label{font-weight:600;display:block;margin:8px 0 6px}
    input[type="file"],input[type="text"],textarea{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px}
    textarea{min-height:96px}
    .btn{appearance:none;border:0;border-radius:12px;background:#1e3a8a;color:#fff;padding:10px 16px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#64748b}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .note{color:var(--muted);font-size:14px;margin:8px 0 4px;text-align:justify}
    .status{margin-top:10px;font-size:14px}
    .ok{color:#0b8a41}.err{color:#b42318}
    .preview{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .preview img{max-height:120px;border:1px solid var(--border);border-radius:10px}
    .progress{height:6px;background:#e6e9ef;border-radius:999px;overflow:hidden;margin-top:10px;display:none}
    .progress>span{display:block;height:100%;width:0;background:#1e3a8a;transition:width .3s ease}
    .legal{
      font-size:12px; /* reduced size as requested */
      line-height:1.5;
      text-align:justify;
      background:#fff;border:1px solid var(--border);
      border-radius:14px;padding:18px;margin-top:20px
    }
    .legal-title{font-weight:bold;font-size:16px;margin-bottom:8px}
    footer{font-size:13px;background:var(--brand-orange);color:#000;margin-top:32px;padding:24px 16px;text-align:center;border-top:1px solid #e07f46}
    footer a{color:#000;text-decoration:underline}
    @media (max-width:820px){.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <img src="pictures/logo.png" alt="SSTLaw Logo" />
    <h1>SCHIRRER SCHONS &amp; TRITSCHLER - ID verification</h1>
  </header>

  <main>
    <div class="card">
      <p class="note"><strong>Currently, only ID cards issued by a member State of the European Economic Area, Switzerland, and the United Kingdom are accepted.</strong> Support for international passports will be implemented soon. Thank you for your understanding.</p>
      <p class="note"><strong>Accepted file formats:</strong> JPG, JPEG, PNG, PDF (max ~10&nbsp;MB total). Upload the <em>front</em> and <em>back</em> of the ID card.</p>

      <div class="row">
        <div>
          <label for="frontFile">Front side</label>
          <input id="frontFile" type="file" accept="image/*,application/pdf" />
          <div id="frontPreview" class="preview"></div>
        </div>
        <div>
          <label for="backFile">Back side (MRZ)</label>
          <input id="backFile" type="file" accept="image/*,application/pdf" />
          <div id="backPreview" class="preview"></div>
        </div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <button id="btnOcr" class="btn secondary" type="button">1 Extract MRZ (OCR)</button>
        <button id="btnVerify" class="btn secondary" type="button">2 Verify MRZ</button>
        <button id="btnSend" class="btn" type="button">3 Send to office</button>
      </div>
      <div id="status" class="status"></div>
      <div class="progress" id="sendProgress"><span></span></div>
    </div>

    <div class="card">
      <label for="mrzText">MRZ text</label>
      <textarea id="mrzText" placeholder="Example (TD1 ID card, 3 lines):
IDLUXSPEC073476210715<<<<<<<<
8308193F3107151LUX<<<<<<<<<<6
SPECIMEN<<JEANNE<<<<<<<<<<<<<"></textarea>
      <p class="note">If OCR is incorrect, please correct the MRZ below exactly as printed on the card, then click “Verify MRZ”.</p>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">Extracted fields</h3>
      <div class="row-3">
        <div><label>Surname</label><input id="outSurname" type="text" /></div>
        <div><label>Given names</label><input id="outGiven" type="text" /></div>
        <div><label>Issuing country</label><input id="outIssuing" type="text" /></div>
        <div><label>Birth date</label><input id="outBirth" type="text" /></div>
        <div><label>Expiry date</label><input id="outExpiry" type="text" /></div>
        <div><label>Document no.</label><input id="outDoc" type="text" /></div>
        <div><label>Nationality</label><input id="outNat" type="text" /></div>
      </div>
    </div>

    <!-- Client due diligence -->
    <div class="legal" id="cdd-notice">
      <p class="legal-title">Client due diligence &amp; data processing notice</p>
      <p>
        By continuing, you acknowledge and accept that <strong>SCHIRRER, SCHONS &amp; TRITSCHLER</strong> (the “Firm”) is subject to mandatory client due diligence obligations under applicable anti-money laundering and counter-terrorism financing legislation. For this purpose, you consent to provide the Firm with the following information: your surname and given name(s), date of birth, <strong>citizenship</strong>, the reference number of your identity card, its issuing country, and its expiry date. This information will be collected and stored strictly in accordance with the provisions of the applicable laws and regulations. In addition, you acknowledge and agree that your current <strong>IPv4 or IPv6 address</strong>, the <strong>user agent</strong> of your internet browser, and the <strong>type of device</strong> used may also be stored alongside the aforementioned information. For the avoidance of doubt, there are no legal or regulatory provisions preventing you from using a virtual private network (VPN) or from modifying/spoofing your browser user agent. <em>No other categories of personal data will be collected.</em> Please note that applicable laws and regulations — notably the <strong>Luxembourg Law of 12 November 2004</strong> on the fight against money laundering and terrorist financing, as amended, <strong>Regulation (EU) 2015/847</strong>, and related EU instruments — may restrict or derogate from certain rights otherwise granted under <strong>Regulation (EU) 2016/679 (General Data Protection Regulation)</strong>. These obligations are further specified in the professional rules applicable to members of the Luxembourg Bar (<em>Règlement Intérieur de l’Ordre des Avocats du Barreau de Luxembourg</em>) and in the regulatory framework of the <strong>Commission de Surveillance du Secteur Financier (CSSF)</strong>, which implement and oversee compliance with these requirements.
      </p>
      <label for="consentChk">
        <input type="checkbox" id="consentChk" />
        <span>I have read and accept this client due diligence &amp; data processing notice.</span>
      </label>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 Schirrer, Schons &amp; Tritschler – All rights reserved. | <a href="https://sstlaw.lu">sstlaw.lu</a></p>
  </footer>

  <!-- Optional: OCR (Tesseract) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <script>
    // === CONFIG ===
    const API_BASE = 'https://sstidcheck-worker.llenert.workers.dev';

    // === UTIL ===
    const statusEl = document.getElementById('status');
    const setStatus = (msg, ok=false)=>{ statusEl.textContent=msg; statusEl.className='status '+(ok?'ok':'err'); };

    async function fileToDataURL(file){
      if(!file) return '';
      if(file.type==='application/pdf'){
        const buf=await file.arrayBuffer();
        const bin=String.fromCharCode(...new Uint8Array(buf));
        return 'data:application/pdf;base64,'+btoa(bin);
      }
      return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
    }
    function dataUrlToBase64(u){ const i=u.indexOf('base64,'); return i>=0?u.slice(i+7):u; }
    function clean(s){ return (s||'').replace(/</g,' ').trim(); }
    function ymd(yyMMdd){
      if(!/^\d{6}$/.test(yyMMdd)) return '';
      const yy=+yyMMdd.slice(0,2), mm=yyMMdd.slice(2,4), dd=yyMMdd.slice(4,6);
      const year = yy>=50 ? 1900+yy : 2000+yy;
      return `${year}-${mm}-${dd}`;
    }

    // TD3/TD1 MRZ parser (short version)
    function parseMrzText(raw){
      const lines = raw.trim().split(/\r?\n/).map(l=>l.replace(/\s+/g,'').toUpperCase()).filter(Boolean);
      if(lines.length<2) throw new Error('Paste 2–3 MRZ lines.');

      // TD3 passport
      if(lines.length===2 && lines[0].length>=40 && lines[1].length>=40){
        const l1=lines[0].padEnd(44,'<'), l2=lines[1].padEnd(44,'<');
        const issuing=l1.slice(2,5);
        const [surRaw, givRaw='']=l1.slice(5).split('<<');
        const doc=l2.slice(0,9).replace(/</g,'');
        const nationality=l2.slice(10,13).replace(/</g,'');
        const birth=ymd(l2.slice(13,19));
        const expiry=ymd(l2.slice(21,27));
        return { surname:clean(surRaw), given_names:clean(givRaw.replace(/<+/g,' ')), issuing_country:issuing, nationality, document_number:doc, birth_date:birth, expiration_date:expiry };
      }
      // TD1 ID card
      if(lines.length>=3 && lines[0].startsWith('ID')){
        const l1=lines[0], l2=lines[1], l3=lines[2];
        const issuing=l1.slice(2,5).replace(/</g,'');
        const docNumber = l1.slice(5).replace(/</g,'');
        const birth = ymd(l2.slice(0,6));
        const expiry= ymd(l2.slice(8,14));
        const nationality = l2.slice(15,18).replace(/</g,'');
        const [surRaw, givRaw=''] = l3.split('<<');
        const given = clean(givRaw.replace(/<+/g,' '));
        return { surname: clean(surRaw), given_names: given, issuing_country: issuing, nationality, document_number: docNumber, birth_date: birth, expiration_date: expiry };
      }
      throw new Error('Unrecognized MRZ format.');
    }

    // === PREVIEWS ===
    async function handlePreview(inputEl, previewEl){
      previewEl.innerHTML='';
      const f=inputEl.files&&inputEl.files[0]; if(!f) return;
      const dataUrl=await fileToDataURL(f);
      if(dataUrl.startsWith('data:image/')){ const img=new Image(); img.src=dataUrl; img.alt='preview'; previewEl.appendChild(img); }
      else previewEl.textContent=f.name+' (PDF)';
    }
    document.getElementById('frontFile').addEventListener('change',e=>handlePreview(e.target,document.getElementById('frontPreview')));
    document.getElementById('backFile') .addEventListener('change',e=>handlePreview(e.target, document.getElementById('backPreview')));

    // === OCR ===
    document.getElementById('btnOcr').addEventListener('click', async ()=>{
      try{
        const back = document.getElementById('backFile').files[0];
        if(!back || !back.type.startsWith('image/')){ setStatus('Please upload a clear back-side image (MRZ).', false); return; }
        setStatus('Running OCR on the back image…', true);
        const { data:{ text } } = await Tesseract.recognize(back, 'eng', { logger: m=>{} });
        const cleaned = text.replace(/[^\w<\n]/g,'').replace(/\r/g,'').trim();
        document.getElementById('mrzText').value = cleaned;
        setStatus('MRZ text extracted via OCR. Please check and correct if needed, then click “Verify MRZ”.', true);
      }catch(e){ console.error(e); setStatus('OCR failed: '+(e.message||e), false); }
    });

    // === VERIFY MRZ ===
    document.getElementById('btnVerify').addEventListener('click',()=>{
      const txt=document.getElementById('mrzText').value||'';
      try{
        const f=parseMrzText(txt);
        document.getElementById('outSurname').value=f.surname||'';
        document.getElementById('outGiven').value=f.given_names||'';
        document.getElementById('outIssuing').value=f.issuing_country||'';
        document.getElementById('outBirth').value=f.birth_date||'';
        document.getElementById('outExpiry').value=f.expiration_date||'';
        document.getElementById('outDoc').value=f.document_number||'';
        document.getElementById('outNat').value=f.nationality||'';
        setStatus('MRZ parsed ✔', true);
      }catch(e){ console.error(e); setStatus('MRZ parse failed: '+e.message,false); }
    });

    // === SEND ===
    document.getElementById('btnSend').addEventListener('click', async ()=>{
      const consent = document.getElementById('consentChk');
      if(!consent.checked){ setStatus('Please accept the client due diligence & data processing notice.', false); return; }

      const meta={
        name:document.getElementById('outSurname').value||'',
        firstname:document.getElementById('outGiven').value||'',
        country:document.getElementById('outIssuing').value||'',
        birthdate:document.getElementById('outBirth').value||'',
        expiry:document.getElementById('outExpiry').value||'',
        document_number:document.getElementById('outDoc').value||'',
        nationality:document.getElementById('outNat').value||'',
        valid:(document.getElementById('mrzText').value||'').trim()? 'true':'false',
        checkedAtUtc:new Date().toISOString(),
        user_agent:navigator.userAgent||'',
        device_type: ( /Mobi|Android/i.test(navigator.userAgent) ? 'mobile' : 'desktop' )
      };

      // Tag real filenames & MIME types + explicit role (front/back)
      const files = [];
      const frontFile = document.getElementById('frontFile');
      const backFile  = document.getElementById('backFile');

      if (frontFile.files[0]) {
        const f = frontFile.files[0];
        const dataUrl = await fileToDataURL(f);
        files.push({
          role: 'front',
          name: f.name || 'front',
          type: f.type || 'application/octet-stream',
          dataBase64: dataUrlToBase64(dataUrl)
        });
      }
      if (backFile.files[0]) {
        const f = backFile.files[0];
        const dataUrl = await fileToDataURL(f);
        files.push({
          role: 'back',
          name: f.name || 'back',
          type: f.type || 'application/octet-stream',
          dataBase64: dataUrlToBase64(dataUrl)
        });
      }

      const bar = document.getElementById('sendProgress');
      const fill = bar.querySelector('span');
      bar.style.display='block'; fill.style.width='20%';
      setStatus('Sending to the office…', true);

      try{
        const res=await fetch(`${API_BASE}/api/send`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({meta,files})
        });
        fill.style.width='80%';
        const j=await res.json();
        if(!res.ok||!j.success) throw new Error(j.error||`HTTP ${res.status}`);
        fill.style.width='100%';
        setStatus('Sent to the office ✔', true);
        setTimeout(()=>{ bar.style.display='none'; fill.style.width='0%'; }, 800);
        alert('Sent ✅ Thank you! We will get back to you shortly.');
      }catch(e){
        console.error(e);
        setStatus('Send failed: '+(e?.message||e), false);
        bar.style.display='none'; fill.style.width='0%';
        alert('Failed to send: '+(e?.message||e));
      }
    });
  </script>
</body>
</html>