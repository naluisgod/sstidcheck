<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SSTLaw ID card MRZ verification</title>
  <meta name="description" content="Upload EEA/CH/UK ID front/back, extract MRZ (optional), verify, and send to SSTLaw." />
  <style>
    /* --- Base / layout (inspired by SSTLaw article pages) --- */
    *{box-sizing:border-box}
    :root{
      --accent:#0a1a3a;          /* deep navy accent */
      --text:#000;               /* black text */
      --border:#e6e7ea;          /* subtle borders */
      --muted:#6a7280;           /* muted copy */
      --bg:#ffffff;              /* white page */
      --card:#ffffff;            /* white cards */
      --btn:#0a1a3a;             /* primary button bg */
      --btn-alt:#7a8599;         /* secondary button bg */
      --radius:14px;
      --shadow:0 1px 2px rgba(0,0,0,.05);
      --shadow-lg:0 10px 30px rgba(0,0,0,.15);
      --maxw:880px;              /* narrow, article-like width */
      --lh:1.6;
    }

    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
      line-height:var(--lh);
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }

    /* Header bar (minimal, solid accent like site) */
    header{
      background:var(--accent);color:#fff;padding:24px 16px;
      box-shadow:var(--shadow);
    }
    header h1{
      margin:0 auto;max-width:var(--maxw);font-size:24px;font-weight:700;letter-spacing:.2px;
    }

    /* Main container & cards */
    main{max-width:var(--maxw);margin:32px auto;padding:0 16px}
    .card{
      background:var(--card);border:1px solid var(--border);
      border-radius:var(--radius);box-shadow:var(--shadow);
      padding:22px 22px 14px;margin:18px 0;
    }

    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .row > *{min-width:0}
    @media (max-width:820px){ .row{grid-template-columns:1fr} }
    .row-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:820px){ .row-3{grid-template-columns:1fr 1fr} }
    @media (max-width:560px){ .row-3{grid-template-columns:1fr} }

    /* Form controls */
    label{font-weight:600;display:block;margin:10px 0 6px}
    input[type="file"],input[type="text"],textarea{
      width:100%;padding:12px;border:1px solid var(--border);
      border-radius:10px;background:#fff;color:var(--text);line-height:1.4;
    }
    textarea{min-height:100px;resize:vertical}

    /* Buttons */
    .btn{
      appearance:none;border:0;border-radius:12px;background:var(--btn);
      color:#fff;padding:10px 16px;font-weight:700;cursor:pointer;box-shadow:var(--shadow);
    }
    .btn.secondary{background:var(--btn-alt)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .steps{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .steps .btn span.step{
      background:#fff;color:var(--accent);display:inline-block;margin-right:8px;
      padding:2px 8px;border-radius:999px;font-weight:800
    }

    /* Links styled like body copy (black, underlined on hover) */
    .link{appearance:none;border:0;background:transparent;color:var(--text);
      text-decoration:underline;cursor:pointer;padding:0;font-weight:600}
    .link:hover{opacity:.85}

    /* Helper text & status lines (justified body style) */
    p,.note,footer{color:var(--text);text-align:justify}
    .note{font-size:14px;margin-top:6px;color:var(--muted)}
    .status{margin-top:10px;font-size:14px}
    .ok{color:#0b8a41}.err{color:#b42318}.info{color:#1e40af}

    /* Previews */
    .preview{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .preview img{max-height:120px;border:1px solid var(--border);border-radius:10px}

    /* Progress bars */
    .prog-wrap{margin-top:10px}
    .prog{height:10px;background:#eef0f4;border-radius:999px;overflow:hidden}
    .prog > .bar{height:100%;width:0;background:var(--btn);transition:width .2s ease}
    .prog-note{font-size:12px;color:var(--text);margin-top:6px}
    .indet .bar{width:30%;animation:indet 1.2s infinite}
    @keyframes indet { 0% {margin-left:-30%} 50%{margin-left:50%} 100%{margin-left:100%} }

    /* Modals (no pop-ups; match article feel) */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000;padding:16px}
    .modal{background:#fff;max-width:760px;width:100%;border:1px solid var(--border);
      border-radius:var(--radius);box-shadow:var(--shadow-lg);overflow:hidden}
    .modal header{background:var(--accent);color:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center}
    .modal header h2{margin:0;font-size:18px}
    .modal .close{background:none;border:none;color:#fff;font-size:20px;cursor:pointer}
    .modal .content{padding:16px;color:var(--text);text-align:justify}
    .modal img{max-width:100%;border:1px solid var(--border);border-radius:8px;margin:10px 0}

    /* “Terms and conditions” block */
    .legal{background:#fafbfc;border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:12px;font-size:15px}
    .legal-title{font-weight:700;margin:0 0 6px 0;color:var(--text)}
    .legal p{margin:0}
    .legal label{display:flex;gap:8px;align-items:flex-start;margin-top:10px}
  </style>

  <!-- Tesseract.js (browser OCR) -->
  <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
</head>
<body>
  <header><h1>SSTLaw ID card MRZ verification</h1></header>

  <main>
    <div class="card">
      <p class="note"><strong>Currently, only ID cards issued by a member State of the European Economic Area, Switzerland, and the United Kingdom are accepted.</strong> Support for international passports will be implemented soon. Thank you for your understanding.</p>

      <p><strong>Accepted file formats:</strong> JPG, JPEG, PNG, PDF (max ~10&nbsp;MB total). Upload the <em>front</em> and <em>back</em> of the ID card.</p>
      <div class="row">
        <div>
          <label for="frontFile">Front side</label>
          <input id="frontFile" type="file" accept="image/*,application/pdf" />
          <div id="frontPreview" class="preview"></div>
        </div>
        <div>
          <label for="backFile">Back side (MRZ)</label>
          <input id="backFile" type="file" accept="image/*,application/pdf" />
          <div id="backPreview" class="preview"></div>
        </div>
      </div>

      <div class="legal">
        <p class="legal-title">Terms and conditions</p>
        <p>
          By continuing, you acknowledge and accept that SCHIRRER, SCHONS &amp; TRITSCHLER (the “Firm”) is subject to mandatory client due diligence obligations under applicable anti-money laundering and counter-terrorism financing legislation. For this purpose, you consent to provide the Firm with the following information: your surname and given name(s), date of birth, the reference number of your identity card, its issuing country, its expiry date, your current IPv6 address, your browser user agent, and your device type. No other categories of personal data will be collected. Please note that applicable laws and regulations, notably the Luxembourg Law of 12 November 2004 on the fight against money laundering and terrorist financing, as amended, Regulation (EU) 2015/847, as well as related EU instruments, may restrict or derogate from certain rights otherwise granted under Regulation (EU) 2016/679 (General Data Protection Regulation). These obligations are further specified in the professional rules applicable to members of the Luxembourg Bar (Règlement Intérieur de l’Ordre des Avocats du Barreau de Luxembourg) and in the regulatory framework of the Commission de Surveillance du Secteur Financier (CSSF), which implement and oversee compliance with these requirements.
        </p>
        <label><input type="checkbox" id="consentChk" /> <span>I have read and accept these terms and conditions.</span></label>
      </div>

      <p class="note">
        Need help?
        <button class="link" id="whatIsMrzBtn">What is MRZ text?</button>
        &nbsp;|&nbsp;
        <button class="link" id="howToCopyBtn">How to extract &amp; copy MRZ on a mobile (iPhone/Android)</button>
      </p>

      <label for="mrzText">MRZ text</label>
      <textarea id="mrzText" placeholder="Paste the MRZ here if needed (3 lines for ID cards)."></textarea>

      <div class="steps">
        <button id="extractBtn" class="btn secondary" type="button" disabled>
          <span class="step">1</span>Extract MRZ from images
        </button>
        <button id="parseMrzBtn" class="btn secondary" type="button" disabled>
          <span class="step">2</span>Verify MRZ
        </button>
        <button id="sendBtn" class="btn" type="button" disabled>
          <span class="step">3</span>Send to office
        </button>
      </div>

      <!-- OCR progress -->
      <div id="ocrProgWrap" class="prog-wrap" style="display:none">
        <div class="prog"><div id="ocrBar" class="bar"></div></div>
        <div id="ocrNote" class="prog-note">OCR starting…</div>
      </div>

      <!-- Send progress -->
      <div id="sendProgWrap" class="prog-wrap" style="display:none">
        <div class="prog indet"><div id="sendBar" class="bar"></div></div>
        <div id="sendNote" class="prog-note">Sending to SSTLaw…</div>
      </div>

      <div id="status" class="status info"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">Extracted fields</h3>
      <div class="row-3">
        <div><label>Surname</label><input id="outSurname" type="text" readonly /></div>
        <div><label>Given names</label><input id="outGiven" type="text" readonly /></div>
        <div><label>Issuing country</label><input id="outIssuing" type="text" readonly /></div>
        <div><label>Nationality</label><input id="outNat" type="text" readonly /></div>
        <div><label>Birth date</label><input id="outBirth" type="text" readonly /></div>
        <div><label>Expiry date</label><input id="outExpiry" type="text" readonly /></div>
        <div><label>Document no.</label><input id="outDoc" type="text" readonly /></div>
      </div>
    </div>
  </main>

  <footer>
    <strong>GDPR &amp; Privacy (brief):</strong> Your uploads are used solely to extract MRZ data and email it to SSTLaw (<code>llenert@sstlaw.lu</code>). Files and derived data are not stored by the website; the email is sent via a secure provider (SendGrid). By using this form, you confirm you have the right to share the images. For data rights (access, rectification, erasure), contact <code>info@sstlaw.lu</code>.
  </footer>

  <!-- MRZ modal -->
  <div id="mrzModal" class="modal-backdrop">
    <div class="modal">
      <header>
        <h2>What is MRZ text?</h2>
        <button class="close" id="closeMrzModal">&times;</button>
      </header>
      <div class="content">
        <p>The <strong>Machine Readable Zone (MRZ)</strong> is the block of two or three lines at the bottom of ID documents, printed in OCR-B font with characters <code>A–Z</code>, digits <code>0–9</code>, and the filler symbol <code>&lt;</code>.</p>
        <img src="pictures/mrz.jpg" alt="MRZ example on ID card">
        <p>In the European Union, the MRZ on standardised identity cards (TD-1 format) always consists of <strong>3 lines of 30 characters</strong>. It encodes the document type, issuing state, document number, dates of birth and expiry, and the holder’s names in a structured way so that it can be automatically read and validated by identity verification systems.</p>
        <p><a href="https://www.consilium.europa.eu/prado/en/prado-glossary/prado-glossary.pdf#page=88" target="_blank" style="color:var(--text);text-decoration:underline">For more information, click here</a></p>
      </div>
    </div>
  </div>

  <!-- How to copy MRZ on mobile modal (JUSTIFIED) -->
  <div id="howModal" class="modal-backdrop">
    <div class="modal">
      <header>
        <h2>How to extract &amp; copy MRZ text on a mobile</h2>
        <button class="close" id="closeHowModal">&times;</button>
      </header>
      <div class="content">
        <p><strong>Goal:</strong> Take a clear photo of the ID card’s MRZ (the 3 lines), select that text on your phone, copy it, and paste it into this page’s “MRZ text” box.</p>
        <p><strong>On iPhone (iOS):</strong></p>
        <ol>
          <li>Open the <em>Camera</em> app and take a focused photo of the MRZ (good lighting, keep it flat and horizontal).</li>
          <li>Open the photo in the <em>Photos</em> app.</li>
          <li>Tap the <em>Live Text</em> icon (or long-press directly on the MRZ lines) until selection handles show.</li>
          <li>Drag to select all three MRZ lines, then tap <em>Copy</em>.</li>
          <li>Return to this page, tap inside the “MRZ text” box, and tap <em>Paste</em>.</li>
        </ol>
        <p><strong>On Android (modern versions):</strong></p>
        <ol>
          <li>Open the <em>Camera</em> app and take a focused photo of the MRZ.</li>
          <li>Open the photo in <em>Google Photos</em> (or your gallery).</li>
          <li>Tap the <em>Lens</em> icon (or <em>Text</em>) to detect selectable text.</li>
          <li>Tap and drag to select all three MRZ lines, then tap <em>Copy</em>.</li>
          <li>Return to this page, tap inside the “MRZ text” box, and tap <em>Paste</em>.</li>
        </ol>
        <p><strong>Tips:</strong> Ensure the MRZ is sharp and well-lit. If only part of a line is selected, zoom in and try again. You can correct characters after pasting, then click “Verify MRZ”.</p>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://sstidcheck-worker.llenert.workers.dev';

    let lastResult = { fields:{}, attachments:{} };
    const statusEl = document.getElementById('status');
    const setStatus = (msg, cls='info') => { statusEl.textContent = msg; statusEl.className = 'status ' + cls; };

    // Consent gating
    const consentChk = document.getElementById('consentChk');
    const extractBtn = document.getElementById('extractBtn');
    const parseBtn   = document.getElementById('parseMrzBtn');
    const sendBtn    = document.getElementById('sendBtn');
    function updateConsent(){
      const ok = !!consentChk.checked;
      extractBtn.disabled = !ok;
      parseBtn.disabled   = !ok;
      sendBtn.disabled    = !ok;
    }
    consentChk.addEventListener('change', updateConsent);
    updateConsent();

    // Modals
    const mrzModal=document.getElementById('mrzModal');
    const howModal=document.getElementById('howModal');
    document.getElementById('whatIsMrzBtn').onclick=()=>{mrzModal.style.display='flex';};
    document.getElementById('closeMrzModal').onclick=()=>{mrzModal.style.display='none';};
    mrzModal.onclick=(e)=>{if(e.target===mrzModal)mrzModal.style.display='none';};

    document.getElementById('howToCopyBtn').onclick=()=>{howModal.style.display='flex';};
    document.getElementById('closeHowModal').onclick=()=>{howModal.style.display='none';};
    howModal.onclick=(e)=>{if(e.target===howModal)howModal.style.display='none';};

    // Progress helpers
    const ocrWrap = document.getElementById('ocrProgWrap');
    const ocrBar  = document.getElementById('ocrBar');
    const ocrNote = document.getElementById('ocrNote');
    function ocrProgress(show, pct, note){
      ocrWrap.style.display = show ? '' : 'none';
      if (pct != null) ocrBar.style.width = Math.max(0, Math.min(100, pct)) + '%';
      if (note) ocrNote.textContent = note;
    }
    const sendWrap = document.getElementById('sendProgWrap');
    function sendProgress(show, note){
      sendWrap.style.display = show ? '' : 'none';
      if (note) document.getElementById('sendNote').textContent = note;
    }

    // ---------- File handling & previews ----------
    async function fileToDataURL(file){
      if(!file) return '';
      if(file.type==='application/pdf'){
        const buf=await file.arrayBuffer();
        const bin=String.fromCharCode(...new Uint8Array(buf));
        return 'data:application/pdf;base64,'+btoa(bin);
      }
      return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
    }
    function dataUrlToBase64(u){ const i=u.indexOf('base64,'); return i>=0?u.slice(i+7):u; }
    function isImageFile(f){ return f && f.type && f.type.startsWith('image/'); }

    async function handlePreview(inputEl, previewEl){
      previewEl.innerHTML='';
      const f=inputEl.files&&inputEl.files[0]; if(!f) return;
      const dataUrl=await fileToDataURL(f);
      if(dataUrl.startsWith('data:image/')){ const img=new Image(); img.src=dataUrl; img.alt='preview'; previewEl.appendChild(img); }
      else previewEl.textContent=f.name+' (PDF)';
      if(inputEl.id==='frontFile') lastResult.attachments.front=dataUrl;
      if(inputEl.id==='backFile')  lastResult.attachments.back=dataUrl;
    }
    document.getElementById('frontFile').addEventListener('change',e=>handlePreview(e.target,document.getElementById('frontPreview')));
    document.getElementById('backFile') .addEventListener('change',e=>handlePreview(e.target, document.getElementById('backPreview')));

    // ---------- Dates & helpers ----------
    function ymd(yyMMdd){
      if(!/^\d{6}$/.test(yyMMdd)) return '';
      const yy=+yyMMdd.slice(0,2), mm=yyMMdd.slice(2,4), dd=yyMMdd.slice(4,6);
      const year = yy>=50 ? 1900+yy : 2000+yy; // 50-year cutoff
      return `${year}-${mm}-${dd}`;
    }
    const clean = (s)=> (s||'').replace(/</g,' ').trim();
    const isAlpha3 = (s)=> /^[A-Z]{3}$/.test(s||'');

    // ---------- MRZ parser (TD3 + TD1 with LU variant) ----------
    function parseMrzText(raw){
      const lines = raw.trim().split(/\r?\n/).map(l=>l.replace(/\s+/g,'').toUpperCase()).filter(Boolean);
      if(lines.length<2) throw new Error('Paste 2–3 MRZ lines.');

      // TD3 passport (future)
      if(lines.length===2 && lines[0].length>=40 && lines[1].length>=40){
        const l1=lines[0].padEnd(44,'<'), l2=lines[1].padEnd(44,'<');
        const issuing=l1.slice(2,5);
        const [surRaw, givRaw='']=l1.slice(5).split('<<');
        const doc=l2.slice(0,9).replace(/</g,'');
        const nationality=l2.slice(10,13).replace(/</g,'');
        const birth=ymd(l2.slice(13,19));
        const sex=l2.slice(20,21).replace('<','U');
        const expiry=ymd(l2.slice(21,27));
        return {
          surname:clean(surRaw), given_names:clean(givRaw.replace(/<+/g,' ')),
          issuing_country:issuing, nationality,
          document_number:doc, birth_date:birth, sex, expiration_date:expiry
        };
      }

      // TD1 ID (Luxembourg-like variant)
      if(lines.length>=3 && lines[0].startsWith('ID')){
        const l1=lines[0], l2=lines[1], l3=lines[2];
        const issuing=l1.slice(2,5).replace(/</g,'');
        const docNumber=l1.slice(5).replace(/</g,'');
        const birth=ymd(l2.slice(0,6));
        const sex=l2.slice(7,8).replace('<','U');
        const expiry=ymd(l2.slice(8,14));
        const nationality=l2.slice(15,18).replace(/</g,'');
        const [surRaw, givRaw='']=l3.split('<<');
        const given = clean(givRaw.replace(/<+/g,' '));
        return {
          surname:clean(surRaw), given_names:given,
          issuing_country:issuing, nationality,
          document_number:docNumber, birth_date:birth, sex, expiration_date:expiry
        };
      }

      // Generic TD1 fallback
      if(lines.length>=3){
        const l1=lines[0], l2=lines[1], l3=lines[2];
        const issuing = l1.slice(2,5).replace(/</g,'');
        const [surRaw, givRaw=''] = l3.split('<<');
        const given = clean(givRaw.replace(/<+/g,' '));
        const idx=[...l2.matchAll(/\d{6}/g)].map(m=>m.index);
        let birth='', expiry='', sex='U';
        if(idx.length>=2){
          birth = ymd(l2.slice(idx[0], idx[0]+6));
          expiry= ymd(l2.slice(idx[1], idx[1]+6));
          sex   = (l2[idx[0]+7]||'<').replace('<','U');
        }
        const docNumber=(l1.slice(5).match(/[A-Z0-9]+/)||[''])[0];
        const nationality=(l2.match(/[A-Z]{3}/g)||[issuing]).pop();
        return {
          surname: clean(surRaw),
          given_names: given,
          issuing_country: issuing,
          nationality,
          document_number: docNumber,
          birth_date: birth,
          sex,
          expiration_date: expiry
        };
      }

      throw new Error('Unrecognized MRZ format.');
    }

    function validateMrz(raw, parsed){
      const lines = raw.trim().split(/\r?\n/).map(l=>l.replace(/\s+/g,'').toUpperCase()).filter(Boolean);
      if (lines.length !== 3) return 'The MRZ should contain exactly 3 lines for an ID card (TD-1).';
      if (!lines.every(l => /^[A-Z0-9<]+$/.test(l))) return 'MRZ must contain only A–Z, digits, and “<” characters.';
      if (!isAlpha3(parsed.issuing_country)) return 'Issuing country code seems invalid.';
      if (!isAlpha3(parsed.nationality)) return 'Nationality code seems invalid.';
      if (!/^\d{4}-\d{2}-\d{2}$/.test(parsed.birth_date)) return 'Birth date could not be read.';
      if (!/^\d{4}-\d{2}-\d{2}$/.test(parsed.expiration_date)) return 'Expiry date could not be read.';
      if (!parsed.surname || !parsed.given_names) return 'Name fields appear empty.';
      if (!parsed.document_number) return 'Document number appears empty.';
      return '';
    }

    async function extractMrzFromImages() {
      const backFile = document.getElementById('backFile').files?.[0];
      const frontFile = document.getElementById('frontFile').files?.[0];

      if ((!backFile || !isImageFile(backFile)) && (!frontFile || !isImageFile(frontFile))) {
        setStatus('Please upload at least one image (JPG/PNG). OCR for PDFs is not supported here. You can paste MRZ manually.', 'err');
        return;
      }

      ocrProgress(true, 0, 'OCR starting…');
      setStatus('Trying to read the MRZ from your image…', 'info');

      const imgFile = (backFile && isImageFile(backFile)) ? backFile : frontFile;
      const url = URL.createObjectURL(imgFile);

      try {
        const result = await Tesseract.recognize(url, 'eng', {
          tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<',
          logger: m => {
            if (m.status === 'recognizing text' && typeof m.progress === 'number') {
              ocrProgress(true, Math.round(m.progress * 100), `OCR ${Math.round(m.progress*100)}%`);
            }
          }
        });
        URL.revokeObjectURL(url);

        const raw = (result.data?.text || '')
          .toUpperCase()
          .replace(/[^\nA-Z0-9<]/g, '');

        const lines = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        const candidates = lines.filter(l => l.length >= 25 && l.length <= 47);
        const picked = candidates.slice(-3);

        if (picked.length < 2) {
          ocrProgress(false);
          setStatus('The recognition software could not reliably read the MRZ. Please type or paste the full MRZ (3 lines) exactly as shown on your ID card, then click “Verify MRZ” again.', 'err');
          return;
        }

        const mrz = picked.join('\n');
        document.getElementById('mrzText').value = mrz;

        ocrProgress(false);
        setStatus('OCR complete. The MRZ has been inserted below. Please check carefully and correct any mistakes before clicking “Verify MRZ”.', 'ok');
      } catch (e) {
        console.error(e);
        ocrProgress(false);
        setStatus('OCR failed. Please paste the MRZ manually, then click “Verify MRZ” again.', 'err');
      }
    }

    extractBtn.addEventListener('click', extractMrzFromImages);

    parseBtn.addEventListener('click', () => {
      const txt=document.getElementById('mrzText').value||'';
      try{
        const parsed=parseMrzText(txt);
        const problem = validateMrz(txt, parsed);
        if (problem) {
          setStatus('The MRZ text appears incomplete or inconsistent. Please review and correct it exactly as printed on your ID card, then click “Verify MRZ” again. (' + problem + ')', 'err');
          return;
        }

        document.getElementById('outSurname').value=parsed.surname||'';
        document.getElementById('outGiven').value  =parsed.given_names||'';
        document.getElementById('outIssuing').value=parsed.issuing_country||'';
        document.getElementById('outNat').value    =parsed.nationality||'';
        document.getElementById('outBirth').value  =parsed.birth_date||'';
        document.getElementById('outExpiry').value =parsed.expiration_date||'';
        document.getElementById('outDoc').value    =parsed.document_number||'';

        lastResult.fields = { ...parsed, mrz_valid:true };
        lastResult.timestamp_utc=new Date().toISOString();
        setStatus('MRZ parsed ✔ The fields below have been filled. Please review them carefully before sending.', 'ok');
      }catch(e){
        console.error(e);
        setStatus('MRZ parse failed. Please paste/correct the 3 MRZ lines exactly as printed and click “Verify MRZ” again.', 'err');
      }
    });

    sendBtn.addEventListener('click', async ()=>{
      try{
        const meta={
          name:document.getElementById('outSurname').value||'',
          firstname:document.getElementById('outGiven').value||'',
          country:document.getElementById('outIssuing').value||'',
          nationality:document.getElementById('outNat').value||'',
          birthdate:document.getElementById('outBirth').value||'',
          expiry:document.getElementById('outExpiry').value||'',
          document_number:document.getElementById('outDoc').value||'',
          valid:String(lastResult?.fields?.mrz_valid||false),
          ip:'', checkedAtUtc:new Date().toISOString()
        };

        const files=[];
        if(lastResult.attachments.front) files.push({name:'front',type:'application/octet-stream',dataBase64:dataUrlToBase64(lastResult.attachments.front)});
        if(lastResult.attachments.back)  files.push({name:'back', type:'application/octet-stream',dataBase64:dataUrlToBase64(lastResult.attachments.back)});

        sendProgress(true, 'Sending to SSTLaw…');
        setStatus('Sending to SSTLaw…', 'info');

        const res=await fetch(`${API_BASE}/api/send`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({meta,files})
        });
        const j=await res.json();

        sendProgress(false);

        if(!res.ok||!j.success) throw new Error(j.error||`HTTP ${res.status}`);
        setStatus('Sent to SSTLaw', 'ok');
        alert('Sent to SSTLaw ✅ Thank you!');
      }catch(e){
        console.error(e);
        sendProgress(false);
        setStatus('Send failed: '+(e?.message||e), 'err');
        alert('Failed to send: '+(e?.message||e));
      }
    });
  </script>
</body>
</html>