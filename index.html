<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SSTLaw ID card MRZ verification</title>
  <meta name="description" content="Upload the front and back of an ID card, read the MRZ, and send to SSTLaw." />

  <!-- Minimal, clean styling -->
  <style>
    :root{--bg:#0a1a3a;--fg:#0f172a;--brand:#1e3a8a;--ink:#0b1220}
    body{font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;margin:0;background:#f7f8fb;color:#0b1220}
    header{background:var(--bg);color:#fff;padding:20px}
    header h1{margin:0;font-size:22px}
    main{max-width:900px;margin:32px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:18px 18px 10px;margin-bottom:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .row-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    label{font-weight:600;display:block;margin:8px 0 6px}
    input[type="file"],input[type="text"],input[type="date"],textarea,select{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px}
    textarea{min-height:86px}
    .btn{appearance:none;border:0;border-radius:12px;background:var(--brand);color:#fff;padding:10px 16px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#64748b}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .note{color:#475569;font-size:13px;margin-top:6px}
    .status{margin-top:10px;font-size:14px}
    .ok{color:#0b8a41}
    .err{color:#b42318}
    .preview{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .preview img{max-height:120px;border:1px solid #e5e7eb;border-radius:10px}
    footer{font-size:13px;color:#475569;margin:32px auto;max-width:900px;padding:0 16px}
    code{background:#f3f4f6;padding:0 4px;border-radius:6px}
  </style>
</head>
<body>
  <header>
    <h1>SSTLaw ID card MRZ verification</h1>
  </header>

  <main>
    <div class="card">
      <p><strong>Accepted file formats:</strong> JPG, JPEG, PNG, PDF (max ~10&nbsp;MB total). Please upload the <em>front</em> and <em>back</em> of the ID card.</p>
      <div class="row">
        <div>
          <label for="frontFile">Front side</label>
          <input id="frontFile" type="file" accept="image/*,application/pdf" />
          <div id="frontPreview" class="preview"></div>
        </div>
        <div>
          <label for="backFile">Back side (MRZ)</label>
          <input id="backFile" type="file" accept="image/*,application/pdf" />
          <div id="backPreview" class="preview"></div>
        </div>
      </div>
      <p class="note">Tip: If OCR doesn’t read the MRZ, paste the two/three MRZ lines below and click “Parse MRZ text”.</p>
      <label for="mrzText">MRZ text (optional)</label>
      <textarea id="mrzText" placeholder="Example (TD1 ID card):
ID<LUXDOE<<JANE<ALICE
LUX1234567<8LUX9001029F3012312<<<<<<<<<6
<<<<<<<<<<<<<<<<<<<<<<<<<"></textarea>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
        <button id="parseMrzBtn" class="btn secondary" type="button">Parse MRZ text</button>
        <button id="processBtn" class="btn secondary" type="button">Process &amp; read MRZ (fallback uses text above)</button>
        <button id="sendBtn" class="btn" type="button">Send to office</button>
      </div>
      <div id="status" class="status"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">Extracted fields</h3>
      <div class="row-3">
        <div><label>Surname</label><input id="outSurname" type="text" /></div>
        <div><label>Given names</label><input id="outGiven" type="text" /></div>
        <div><label>Issuing country</label><input id="outIssuing" type="text" /></div>
        <div><label>Birth date</label><input id="outBirth" type="text" /></div>
        <div><label>Expiry date</label><input id="outExpiry" type="text" /></div>
        <div><label>Document no.</label><input id="outDoc" type="text" /></div>
      </div>
      <p class="note">You can correct values here before sending.</p>
    </div>
  </main>

  <footer>
    <strong>GDPR &amp; Privacy (brief):</strong> Your uploads are used solely to extract MRZ data and email it to SSTLaw (<code>llenert@sstlaw.lu</code>).
    Files and derived data are not stored by the website; the email is sent via a secure provider (SendGrid). By using this form, you confirm you have the right to share the images. For data rights (access, rectification, erasure), contact <code>info@sstlaw.lu</code>.  
  </footer>

  <script>
    // === CONFIG ===
    const API_BASE = 'https://sstidcheck-worker.llenert.workers.dev';

    // === STATE ===
    let lastResult = null; // what we'll send to the Worker

    // === UTIL ===
    const statusEl = document.getElementById('status');
    function setStatus(msg, ok=false){ statusEl.textContent = msg; statusEl.className = 'status ' + (ok?'ok':'err'); }

    async function fileToDataURL(file) {
      if (!file) return '';
      if (file.type === 'application/pdf') {
        // We won't preview PDFs, but still encode for sending
        const buf = await file.arrayBuffer();
        const bin = String.fromCharCode(...new Uint8Array(buf));
        return 'data:application/pdf;base64,' + btoa(bin);
      }
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }
    function dataUrlToBase64(dataUrl) {
      if (!dataUrl) return '';
      const i = dataUrl.indexOf('base64,');
      return i >= 0 ? dataUrl.slice(i + 7) : dataUrl;
    }
    function ymdFromYYMMDD(yyMMdd) {
      const yy = parseInt(yyMMdd.slice(0,2),10);
      const year = yy >= 30 ? 1900 + yy : 2000 + yy;
      return `${year}-${yyMMdd.slice(2,4)}-${yyMMdd.slice(4,6)}`;
    }
    function clean(s){ return (s||'').replace(/</g,' ').trim(); }

    // === MRZ PARSER (TD3 passports or TD1 ID cards) ===
    function parseMrzText(linesRaw) {
      const lines = linesRaw.trim().split(/\r?\n/).map(l => l.replace(/\s+/g,'').toUpperCase()).filter(Boolean);
      if (lines.length < 2) throw new Error('Paste at least 2 MRZ lines.');

      const isTD3 = lines.length >= 2 && lines[0].length >= 40 && lines[1].length >= 40;
      const isTD1 = lines.length >= 3 && lines[0].length >= 28 && lines[1].length >= 28 && lines[2].length >= 28;

      if (isTD3) {
        const l1 = lines[0].padEnd(44,'<');
        const l2 = lines[1].padEnd(44,'<');
        const issuing = l1.slice(2,5);
        const [surnameRaw, givenRaw=''] = l1.slice(5).split('<<');
        const docNum = l2.slice(0,9).replace(/</g,'');
        const nationality = l2.slice(10,13);
        const birth = ymdFromYYMMDD(l2.slice(13,19));
        const sex = l2.slice(20,21);
        const expiry = ymdFromYYMMDD(l2.slice(21,27));
        return {
          surname: clean(surnameRaw),
          given_names: clean(givenRaw.replace(/<+/g,' ')),
          issuing_country: issuing,
          nationality, document_number: docNum,
          birth_date: birth, sex, expiration_date: expiry
        };
      }

      if (isTD1) {
        const l1 = lines[0].padEnd(30,'<');
        const l2 = lines[1].padEnd(30,'<');
        const issuing = l1.slice(2,5);
        const [surnameRaw, givenRaw=''] = l1.slice(5).split('<<');
        const docNum = l2.slice(0,9).replace(/</g,'');
        const nationality = l2.slice(10,13);
        const birth = ymdFromYYMMDD(l2.slice(13,19));
        const sex = l2.slice(20,21);
        const expiry = ymdFromYYMMDD(l2.slice(21,27));
        return {
          surname: clean(surnameRaw),
          given_names: clean(givenRaw.replace(/<+/g,' ')),
          issuing_country: issuing,
          nationality, document_number: docNum,
          birth_date: birth, sex, expiration_date: expiry
        };
      }

      throw new Error('Unrecognized MRZ format. Paste raw MRZ lines (2 for passport, 3 for ID).');
    }

    // === UI handlers ===
    async function handlePreview(inputEl, previewEl) {
      previewEl.innerHTML = '';
      const file = inputEl.files && inputEl.files[0];
      if (!file) return;
      const dataUrl = await fileToDataURL(file);
      if (dataUrl.startsWith('data:image/')) {
        const img = new Image(); img.src = dataUrl; img.alt = 'preview';
        previewEl.appendChild(img);
      } else {
        previewEl.textContent = file.name + ' (PDF)';
      }
      // keep on lastResult for sending
      lastResult = lastResult || { fields: {}, attachments: {} };
      if (inputEl.id === 'frontFile') lastResult.attachments.front = dataUrl;
      if (inputEl.id === 'backFile')  lastResult.attachments.back  = dataUrl;
    }

    document.getElementById('frontFile').addEventListener('change', e => handlePreview(e.target, document.getElementById('frontPreview')));
    document.getElementById('backFile') .addEventListener('change', e => handlePreview(e.target,  document.getElementById('backPreview')));

    document.getElementById('parseMrzBtn').addEventListener('click', () => {
      const mrzText = document.getElementById('mrzText').value || '';
      try {
        const f = parseMrzText(mrzText);
        // update fields on screen
        document.getElementById('outSurname').value = f.surname || '';
        document.getElementById('outGiven').value   = f.given_names || '';
        document.getElementById('outIssuing').value = f.issuing_country || '';
        document.getElementById('outBirth').value   = f.birth_date || '';
        document.getElementById('outExpiry').value  = f.expiration_date || '';
        document.getElementById('outDoc').value     = f.document_number || '';
        // stash in state
        lastResult = lastResult || { attachments: {} };
        lastResult.fields = { ...f, mrz_valid: true };
        lastResult.timestamp_utc = new Date().toISOString();
        setStatus('MRZ parsed ✔', true);
      } catch (e) {
        console.error(e);
        setStatus('MRZ parse failed: ' + e.message, false);
      }
    });

    // Fallback: “Process & read MRZ” just tries to parse whatever is in the text box
    document.getElementById('processBtn').addEventListener('click', () => {
      document.getElementById('parseMrzBtn').click();
    });

    document.getElementById('sendBtn').addEventListener('click', async () => {
      try {
        // Build meta from visible fields (user can correct before sending)
        const meta = {
          name:       document.getElementById('outSurname').value || '',
          firstname:  document.getElementById('outGiven').value || '',
          country:    document.getElementById('outIssuing').value || '',
          birthdate:  document.getElementById('outBirth').value || '',
          expiry:     document.getElementById('outExpiry').value || '',
          valid:      String((lastResult && lastResult.fields && lastResult.fields.mrz_valid) || false),
          ip:         '', // optional: can fetch ipify here if you want
          checkedAtUtc: new Date().toISOString()
        };

        // Prepare attachments (0–2)
        const files = [];
        if (lastResult && lastResult.attachments && lastResult.attachments.front) {
          files.push({
            name:'front', type: 'application/octet-stream',
            dataBase64: dataUrlToBase64(lastResult.attachments.front)
          });
        }
        if (lastResult && lastResult.attachments && lastResult.attachments.back) {
          files.push({
            name:'back', type: 'application/octet-stream',
            dataBase64: dataUrlToBase64(lastResult.attachments.back)
          });
        }

        setStatus('Sending to SSTLaw…', true);
        const res = await fetch(`${API_BASE}/api/send`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ meta, files })
        });
        const j = await res.json();
        if (!res.ok || !j.success) throw new Error(j.error || `HTTP ${res.status}`);
        setStatus('Sent to office ✔', true);
        alert('Sent to office ✅');
      } catch (e) {
        console.error(e);
        setStatus('Send failed: ' + (e?.message || e), false);
        alert('Failed to send: ' + (e?.message || e));
      }
    });
  </script>
</body>
</html>