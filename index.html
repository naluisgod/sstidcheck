<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SCHIRRER SCHONS & TRITSCHLER - ID verification</title>
  <meta name="description" content="Upload the front and back of an ID card, read the MRZ, and send to SSTLaw." />
  <style>
    :root{
      --brand-blue:#23568d;
      --brand-orange:#ef8d53;
      --text:#0b1220;
      --muted:#475569;
      --border:#e5e7eb;
      --bg:#f7f8fb;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
    header{background:#fff;color:var(--brand-blue);padding:20px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border)}
    header img{height:42px}
    header h1{margin:0;font-size:22px}
    main{max-width:980px;margin:28px auto;padding:0 16px}
    .card{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:18px 18px 12px;margin-bottom:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .row-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:820px){.row{grid-template-columns:1fr}.row-3{grid-template-columns:1fr}}
    label{font-weight:600;display:block;margin:8px 0 6px}
    input[type="file"],input[type="text"],textarea{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px}
    textarea{min-height:96px}
    .btn{appearance:none;border:0;border-radius:12px;background:#1e3a8a;color:#fff;padding:10px 16px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#64748b}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .note{color:var(--muted);font-size:14px;margin:8px 0 4px;text-align:justify}
    .status{margin-top:10px;font-size:14px}
    .ok{color:#0b8a41}.err{color:#b42318}.info{color:#1e40af}
    .preview{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .preview img{max-height:120px;border:1px solid var(--border);border-radius:10px}
    .progress{height:6px;background:#e6e9ef;border-radius:999px;overflow:hidden;margin-top:10px;display:none}
    .progress>span{display:block;height:100%;width:0;background:#1e3a8a;transition:width .3s ease}
    .legal{
      font-size:12px; /* smaller as requested */
      line-height:1.5;
      text-align:justify;
      background:#fff;border:1px solid var(--border);
      border-radius:14px;padding:18px;margin-top:4px
    }
    .legal-title{font-weight:bold;font-size:16px;margin-bottom:8px}
    .gated[aria-disabled="true"]{opacity:.6;pointer-events:none;user-select:none}
    .link{appearance:none;border:0;background:transparent;color:#0b1220;text-decoration:underline;cursor:pointer;padding:0;font-weight:600}
    .link:hover{opacity:.9}
    /* Modals */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000;padding:16px}
    .modal{background:#fff;max-width:760px;width:100%;border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden}
    .modal header{background:#23568d;color:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center}
    .modal header h2{margin:0;font-size:18px}
    .modal .close{background:none;border:none;color:#fff;font-size:20px;cursor:pointer}
    .modal .content{padding:16px;color:#0b1220;text-align:justify}
    .modal img{max-width:100%;border:1px solid var(--border);border-radius:8px;margin:10px 0}

    footer{font-size:13px;background:var(--brand-orange);color:#000;margin-top:32px;padding:24px 16px;text-align:center;border-top:1px solid #e07f46}
    footer a{color:#000;text-decoration:underline}
  </style>
</head>
<body>
  <header>
    <img src="pictures/logo.png" alt="SSTLaw Logo" />
    <h1>SCHIRRER SCHONS &amp; TRITSCHLER - ID verification</h1>
  </header>

  <main>
    <!-- 1) CONSENT FIRST -->
    <div class="card">
      <div class="legal" id="cdd-notice">
        <p class="legal-title">Client due diligence &amp; data processing notice</p>
        <p>
          By continuing, you acknowledge and accept that <strong>SCHIRRER, SCHONS &amp; TRITSCHLER</strong> (the “Firm”) is subject to mandatory client due diligence obligations under applicable anti-money laundering and counter-terrorism financing legislation. For this purpose, you consent to provide the Firm with the following information: your surname and given name(s), date of birth, <strong>citizenship</strong>, the reference number of your identity card, its issuing country, and its expiry date. This information will be collected and stored strictly in accordance with the provisions of the applicable laws and regulations. In addition, you acknowledge and agree that your current <strong>IPv4 or IPv6 address</strong>, the <strong>user agent</strong> of your internet browser, and the <strong>type of device</strong> used may also be stored alongside the aforementioned information. For the avoidance of doubt, there are no legal or regulatory provisions preventing you from using a virtual private network (VPN) or from modifying/spoofing your browser user agent. <em>No other categories of personal data will be collected.</em> Please note that applicable laws and regulations — notably the <strong>Luxembourg Law of 12 November 2004</strong> on the fight against money laundering and terrorist financing, as amended, <strong>Regulation (EU) 2015/847</strong>, and related EU instruments — may restrict or derogate from certain rights otherwise granted under <strong>Regulation (EU) 2016/679 (General Data Protection Regulation)</strong>. These obligations are further specified in the professional rules applicable to members of the Luxembourg Bar (<em>Règlement Intérieur de l’Ordre des Avocats du Barreau de Luxembourg</em>) and in the regulatory framework of the <strong>Commission de Surveillance du Secteur Financier (CSSF)</strong>, which implement and oversee compliance with these requirements.
        </p>
        <label for="consentChk">
          <input type="checkbox" id="consentChk" />
          <span>I have read and accept this client due diligence &amp; data processing notice.</span>
        </label>
      </div>
    </div>

    <!-- 2) HELP (always clickable) -->
    <div class="card">
      <p class="note" style="margin-top:0">
        Need help?
        <button class="link" id="whatIsMrzBtn">What is MRZ text?</button>
        &nbsp;|&nbsp;
        <button class="link" id="howToCopyBtn">How to extract &amp; copy MRZ on a mobile (iPhone/Android)</button>
      </p>
    </div>

    <!-- 3) GATED CONTROLS (disabled until consent) -->
    <div class="card gated" id="gateUploads" aria-disabled="true">
      <p class="note"><strong>Currently, only ID cards issued by a member State of the European Economic Area, Switzerland, and the United Kingdom are accepted.</strong> Support for international passports will be implemented soon. Thank you for your understanding.</p>
      <p class="note"><strong>Accepted file formats:</strong> JPG, JPEG, PNG, PDF (max ~10&nbsp;MB total). Upload the <em>front</em> and <em>back</em> of the ID card.</p>

      <div class="row">
        <div>
          <label for="frontFile">Front side</label>
          <input id="frontFile" type="file" accept="image/*,application/pdf" disabled />
          <div id="frontPreview" class="preview"></div>
        </div>
        <div>
          <label for="backFile">Back side (MRZ)</label>
          <input id="backFile" type="file" accept="image/*,application/pdf" disabled />
          <div id="backPreview" class="preview"></div>
        </div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <button id="btnOcr" class="btn secondary" type="button" disabled>1 Extract MRZ (OCR)</button>
        <button id="btnVerify" class="btn secondary" type="button" disabled>2 Verify MRZ</button>
        <button id="btnSend" class="btn" type="button" disabled>3 Send to office</button>
      </div>
      <div id="status" class="status"></div>
      <div class="progress" id="sendProgress"><span></span></div>
    </div>

    <div class="card gated" id="gateMrz" aria-disabled="true">
      <label for="mrzText">MRZ text</label>
      <textarea id="mrzText" placeholder="Example (TD1 ID card, 3 lines):
IDLUXSPEC073476210715<<<<<<<<
8308193F3107151LUX<<<<<<<<<<6
SPECIMEN<<JEANNE<<<<<<<<<<<<<" disabled></textarea>
      <p class="note">If OCR is incorrect, please correct the MRZ below exactly as printed on the card, then click “Verify MRZ”.</p>
    </div>

    <div class="card gated" id="gateFields" aria-disabled="true">
      <h3 style="margin:0 0 8px">Extracted fields</h3>
      <div class="row-3">
        <div><label>Surname</label><input id="outSurname" type="text" disabled/></div>
        <div><label>Given names</label><input id="outGiven" type="text" disabled/></div>
        <div><label>Issuing country</label><input id="outIssuing" type="text" disabled/></div>
        <div><label>Birth date</label><input id="outBirth" type="text" disabled/></div>
        <div><label>Expiry date</label><input id="outExpiry" type="text" disabled/></div>
        <div><label>Document no.</label><input id="outDoc" type="text" disabled/></div>
        <div><label>Nationality</label><input id="outNat" type="text" disabled/></div>
      </div>
    </div>
  </main>

  <!-- “What is MRZ?” modal -->
  <div id="mrzModal" class="modal-backdrop">
    <div class="modal">
      <header>
        <h2>What is MRZ text?</h2>
        <button class="close" id="closeMrzModal">&times;</button>
      </header>
      <div class="content">
        <p>The <strong>Machine Readable Zone (MRZ)</strong> is the block of two or three lines at the bottom of ID documents, printed in OCR-B font with characters <code>A–Z</code>, digits <code>0–9</code>, and the filler symbol <code>&lt;</code>.</p>
        <img src="pictures/mrz.jpg" alt="MRZ example on ID card">
        <p>In the European Union, the MRZ on standardised identity cards (TD-1 format) always consists of <strong>3 lines of 30 characters</strong>. It encodes the document type, issuing state, document number, dates of birth and expiry, and the holder’s names in a structured way so that it can be automatically read and validated by identity verification systems.</p>
        <p><a href="https://www.consilium.europa.eu/prado/en/prado-glossary/prado-glossary.pdf#page=88" target="_blank" style="color:#0b1220;text-decoration:underline">For more information, click here</a></p>
      </div>
    </div>
  </div>

  <!-- “How to use your phone” modal -->
  <div id="howModal" class="modal-backdrop">
    <div class="modal">
      <header>
        <h2>How to extract &amp; copy MRZ text on a mobile</h2>
        <button class="close" id="closeHowModal">&times;</button>
      </header>
      <div class="content">
        <p><strong>Goal:</strong> Take a clear photo of the ID card’s MRZ (the 3 lines), select that text on your phone, copy it, and paste it into this page’s “MRZ text” box.</p>
        <p><strong>On iPhone (iOS):</strong></p>
        <ol>
          <li>Open the <em>Camera</em> app and take a focused photo of the MRZ (good lighting, keep it flat and horizontal).</li>
          <li>Open the photo in the <em>Photos</em> app.</li>
          <li>Tap the <em>Live Text</em> icon (or long-press directly on the MRZ lines) until selection handles show.</li>
          <li>Drag to select all three MRZ lines, then tap <em>Copy</em>.</li>
          <li>Return to this page, tap inside the “MRZ text” box, and tap <em>Paste</em>.</li>
        </ol>
        <p><strong>On Android (modern versions):</strong></p>
        <ol>
          <li>Open the <em>Camera</em> app and take a focused photo of the MRZ.</li>
          <li>Open the photo in <em>Google Photos</em> (or your gallery).</li>
          <li>Tap the <em>Lens</em> icon (or <em>Text</em>) to detect selectable text.</li>
          <li>Tap and drag to select all three MRZ lines, then tap <em>Copy</em>.</li>
          <li>Return to this page, tap inside the “MRZ text” box, and tap <em>Paste</em>.</li>
        </ol>
        <p><strong>Tips:</strong> Ensure the MRZ is sharp and well-lit. If only part of a line is selected, zoom in and try again. You can correct characters after pasting, then click “Verify MRZ”.</p>
      </div>
    </div>
  </div>

  <footer>
    <p>&copy; 2025 Schirrer, Schons &amp; Tritschler – All rights reserved. | <a href="https://sstlaw.lu">sstlaw.lu</a></p>
  </footer>

  <!-- OCR (Tesseract) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <script>
    // === CONFIG ===
    const API_BASE = 'https://sstidcheck-worker.llenert.workers.dev';

    // === CONSENT GATING ===
    const gateSections = [
      document.getElementById('gateUploads'),
      document.getElementById('gateMrz'),
      document.getElementById('gateFields')
    ];
    const toToggle = [
      'frontFile','backFile','mrzText',
      'outSurname','outGiven','outIssuing','outBirth','outExpiry','outDoc','outNat',
      'btnOcr','btnVerify','btnSend'
    ].map(id=>document.getElementById(id));

    document.getElementById('consentChk').addEventListener('change', (e)=>{
      const enabled = e.target.checked;
      gateSections.forEach(s => s.setAttribute('aria-disabled', enabled ? 'false' : 'true'));
      toToggle.forEach(el => { if(el) el.disabled = !enabled; });
    });

    // === HELP MODALS ===
    const mrzModal=document.getElementById('mrzModal');
    const howModal=document.getElementById('howModal');
    document.getElementById('whatIsMrzBtn').onclick=()=>{mrzModal.style.display='flex';};
    document.getElementById('closeMrzModal').onclick=()=>{mrzModal.style.display='none';};
    mrzModal.onclick=(e)=>{if(e.target===mrzModal)mrzModal.style.display='none';};
    document.getElementById('howToCopyBtn').onclick=()=>{howModal.style.display='flex';};
    document.getElementById('closeHowModal').onclick=()=>{howModal.style.display='none';};
    howModal.onclick=(e)=>{if(e.target===howModal)howModal.style.display='none';};

    // === UTIL ===
    const statusEl = document.getElementById('status');
    const setStatus = (msg, cls='info')=>{ statusEl.textContent=msg; statusEl.className='status '+cls; };

    async function fileToDataURL(file){
      if(!file) return '';
      if(file.type==='application/pdf'){
        const buf=await file.arrayBuffer();
        const bin=String.fromCharCode(...new Uint8Array(buf));
        return 'data:application/pdf;base64,'+btoa(bin);
      }
      return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
    }
    function dataUrlToBase64(u){ const i=u.indexOf('base64,'); return i>=0?u.slice(i+7):u; }
    function clean(s){ return (s||'').replace(/</g,' ').trim(); }

    // ---- MRZ strict helpers (checksums, dates) ----
    function charVal(c){
      if (c === '<') return 0;
      if (c >= '0' && c <= '9') return c.charCodeAt(0) - 48;
      if (c >= 'A' && c <= 'Z') return c.charCodeAt(0) - 55; // 'A'->10 … 'Z'->35
      return NaN;
    }
    function mrzChecksum(s){
      const weights = [7,3,1];
      let sum = 0;
      for (let i=0;i<s.length;i++){
        const v = charVal(s[i]);
        if (Number.isNaN(v)) return NaN;
        sum += v * weights[i % 3];
      }
      return (sum % 10);
    }
    function onlyMrzChars(s){ return /^[A-Z0-9<\n\r]+$/.test(s); }
    function isYYMMDD(s){
      if(!/^\d{6}$/.test(s)) return false;
      const yy = +s.slice(0,2), mm = +s.slice(2,4), dd = +s.slice(4,6);
      if(mm<1 || mm>12) return false;
      const daysInMonth = new Date(2000, mm, 0).getDate();
      if(dd<1 || dd>daysInMonth) return false;
      return true;
    }
    function toISODate(yyMMdd){
      const yy = +yyMMdd.slice(0,2), mm = yyMMdd.slice(2,4), dd = yyMMdd.slice(4,6);
      const year = yy >= 50 ? 1900 + yy : 2000 + yy; // 50-year cutoff
      return `${year}-${mm}-${dd}`;
    }
    function assert(cond, msg){ if(!cond) throw new Error(msg); }

    // ---- STRICT MRZ PARSER (TD3 & TD1) ----
    function parseMrzText(raw){
      let text = raw.trim().toUpperCase().replace(/\s+$/,'');
      assert(text.length > 0, 'Empty MRZ.');
      assert(onlyMrzChars(text.replace(/\r/g,'')), 'MRZ contains invalid characters. Use only A–Z, 0–9 and "<".');

      const lines = text.split(/\r?\n/).map(l=>l.replace(/\s+/g,'')).filter(Boolean);
      assert(lines.length === 2 || lines.length === 3, 'MRZ must have 2 (passport) or 3 (ID) lines.');

      // TD3 passport
      if (lines.length === 2 && lines[0].length >= 40 && lines[1].length >= 40) {
        const L1 = lines[0].padEnd(44,'<');
        const L2 = lines[1].padEnd(44,'<');

        const docType = L1.slice(0,2);
        const issuing = L1.slice(2,5);
        const namePart = L1.slice(5);
        const [surRaw, givRaw=''] = namePart.split('<<');

        const docNumber = L2.slice(0,9);
        const docChk    = L2.slice(9,10);
        const nationality = L2.slice(10,13);
        const birth     = L2.slice(13,19);
        const birthChk  = L2.slice(19,20);
        const sex       = L2.slice(20,21);
        const expiry    = L2.slice(21,27);
        const expiryChk = L2.slice(27,28);

        assert(/^[A-Z<]{2}$/.test(docType), 'Invalid doc type.');
        assert(/^[A-Z<]{3}$/.test(issuing), 'Invalid issuing state (3 letters).');
        assert(/^[A-Z<]+$/.test(namePart), 'Invalid name block.');

        assert(/^\d$/.test(docChk), 'Missing doc-number checksum.');
        assert(mrzChecksum(docNumber) === +docChk, 'Document number checksum failed.');

        assert(/^\d{6}$/.test(birth) && /^\d$/.test(birthChk), 'Invalid birth date / checksum.');
        assert(mrzChecksum(birth) === +birthChk, 'Birth date checksum failed.');
        assert(isYYMMDD(birth), 'Birth date not a valid YYMMDD.');

        assert(/^\d{6}$/.test(expiry) && /^\d$/.test(expiryChk), 'Invalid expiry date / checksum.');
        assert(mrzChecksum(expiry) === +expiryChk, 'Expiry date checksum failed.');
        assert(isYYMMDD(expiry), 'Expiry date not a valid YYMMDD.');

        const birthISO = toISODate(birth);
        const expiryISO = toISODate(expiry);

        assert(/^[A-Z<]{3}$/.test(nationality), 'Invalid nationality (3 letters).');

        return {
          surname: surRaw.replace(/<+/g,' ').trim(),
          given_names: (givRaw||'').replace(/<+/g,' ').trim(),
          issuing_country: issuing.replace(/</g,''),
          nationality: nationality.replace(/</g,''),
          document_number: docNumber.replace(/</g,''),
          birth_date: birthISO,
          sex: sex === '<' ? 'U' : sex,
          expiration_date: expiryISO
        };
      }

      // TD1 ID card
      if (lines.length === 3) {
        const L1 = lines[0], L2 = lines[1], L3 = lines[2];

        assert(L1.startsWith('ID'), 'TD1 ID should start with "ID".');

        const issuing = L1.slice(2,5).replace(/</g,'');
        assert(/^[A-Z]{3}$/.test(issuing), 'Invalid issuing state (3 letters).');

        const docMatch = L1.slice(5).match(/^[A-Z0-9<]+/);
        assert(!!docMatch, 'Missing document number.');
        const docRaw = (docMatch[0] || '').replace(/</g,'');
        assert(/^[A-Z0-9]+$/.test(docRaw) && docRaw.length >= 6 && docRaw.length <= 14, 'Invalid document number.');

        const birth = L2.slice(0,6);
        const birthChk = L2.slice(6,7);
        const sex  = L2.slice(7,8);
        const expiry = L2.slice(8,14);
        const expiryChk = L2.slice(14,15);

        assert(/^\d{6}$/.test(birth) && /^\d$/.test(birthChk), 'Invalid birth date / checksum (TD1).');
        assert(mrzChecksum(birth) === +birthChk, 'Birth date checksum failed (TD1).');
        assert(isYYMMDD(birth), 'Birth date not a valid YYMMDD.');

        assert(/^\d{6}$/.test(expiry) && /^\d$/.test(expiryChk), 'Invalid expiry date / checksum (TD1).');
        assert(mrzChecksum(expiry) === +expiryChk, 'Expiry date checksum failed (TD1).');
        assert(isYYMMDD(expiry), 'Expiry date not a valid YYMMDD.');

        const nationality = (L2.slice(15,18) || '').replace(/</g,'');
        assert(/^[A-Z]{3}$/.test(nationality), 'Invalid nationality (3 letters).');

        const [surRaw, givRaw=''] = L3.split('<<');
        assert(!!surRaw, 'Missing surname block.');
        const surname = surRaw.replace(/<+/g,' ').trim();
        const given   = (givRaw||'').replace(/<+/g,' ').trim();
        assert(surname.length>0 && given.length>0, 'Missing surname or given names.');

        return {
          surname,
          given_names: given,
          issuing_country: issuing,
          nationality,
          document_number: docRaw,
          birth_date: toISODate(birth),
          sex: sex === '<' ? 'U' : sex,
          expiration_date: toISODate(expiry)
        };
      }

      throw new Error('Unrecognized MRZ format.');
    }

    // === PREVIEWS ===
    async function handlePreview(inputEl, previewEl){
      previewEl.innerHTML='';
      const f=inputEl.files&&inputEl.files[0]; if(!f) return;
      const dataUrl=await fileToDataURL(f);
      if(dataUrl.startsWith('data:image/')){ const img=new Image(); img.src=dataUrl; img.alt='preview'; previewEl.appendChild(img); }
      else previewEl.textContent=f.name+' (PDF)';
    }
    document.getElementById('frontFile').addEventListener('change',e=>handlePreview(e.target,document.getElementById('frontPreview')));
    document.getElementById('backFile') .addEventListener('change',e=>handlePreview(e.target, document.getElementById('backPreview')));

    // === OCR (step 1) ===
    document.getElementById('btnOcr').addEventListener('click', async ()=>{
      try{
        const back = document.getElementById('backFile').files[0];
        if(!back || !back.type.startsWith('image/')){ setStatus('Please upload a clear back-side image (MRZ).', 'err'); return; }
        setStatus('Running OCR on the back image…', 'info');
        const { data:{ text } } = await Tesseract.recognize(back, 'eng', { logger: m=>{} });
        const cleaned = text
          .toUpperCase()
          .replace(/[^A-Z0-9<\n\r]/g,'')  // keep only MRZ chars
          .replace(/[|]/g,'<')            // common OCR confusion
          .replace(/\r/g,'')
          .trim();
        document.getElementById('mrzText').value = cleaned;
        setStatus('MRZ text extracted via OCR. Please check and correct if needed, then click “Verify MRZ”.', 'ok');
      }catch(e){ console.error(e); setStatus('OCR failed: '+(e.message||e), 'err'); }
    });

    // === VERIFY (step 2) ===
    document.getElementById('btnVerify').addEventListener('click',()=>{
      const txt=document.getElementById('mrzText').value||'';
      try{
        const f=parseMrzText(txt);
        document.getElementById('outSurname').value=f.surname||'';
        document.getElementById('outGiven').value=f.given_names||'';
        document.getElementById('outIssuing').value=f.issuing_country||'';
        document.getElementById('outBirth').value=f.birth_date||'';
        document.getElementById('outExpiry').value=f.expiration_date||'';
        document.getElementById('outDoc').value=f.document_number||'';
        document.getElementById('outNat').value=f.nationality||'';
        setStatus('MRZ parsed and validated ✔', 'ok');
      }catch(e){ console.error(e); setStatus('MRZ parse failed: '+e.message,'err'); }
    });

    // === SEND (step 3) ===
    document.getElementById('btnSend').addEventListener('click', async ()=>{
      const consent = document.getElementById('consentChk');
      if(!consent.checked){ setStatus('Please accept the client due diligence & data processing notice.', 'err'); return; }

      const meta={
        name:document.getElementById('outSurname').value||'',
        firstname:document.getElementById('outGiven').value||'',
        country:document.getElementById('outIssuing').value||'',
        birthdate:document.getElementById('outBirth').value||'',
        expiry:document.getElementById('outExpiry').value||'',
        document_number:document.getElementById('outDoc').value||'',
        nationality:document.getElementById('outNat').value||'',
        valid:(document.getElementById('mrzText').value||'').trim()? 'true':'false',
        checkedAtUtc:new Date().toISOString(),
        user_agent:navigator.userAgent||'',
        device_type: ( /Mobi|Android/i.test(navigator.userAgent) ? 'mobile' : 'desktop' )
      };

      // Files with explicit role (front/back) + original name/type
      const files = [];
      const frontFile = document.getElementById('frontFile');
      const backFile  = document.getElementById('backFile');

      if (frontFile.files[0]) {
        const f = frontFile.files[0];
        const dataUrl = await fileToDataURL(f);
        files.push({
          role: 'front',
          name: f.name || 'front',
          type: f.type || 'application/octet-stream',
          dataBase64: dataUrlToBase64(dataUrl)
        });
      }
      if (backFile.files[0]) {
        const f = backFile.files[0];
        const dataUrl = await fileToDataURL(f);
        files.push({
          role: 'back',
          name: f.name || 'back',
          type: f.type || 'application/octet-stream',
          dataBase64: dataUrlToBase64(dataUrl)
        });
      }

      const bar = document.getElementById('sendProgress');
      const fill = bar.querySelector('span');
      bar.style.display='block'; fill.style.width='20%';
      setStatus('Sending to the office…', 'info');

      try{
        const res=await fetch(`${API_BASE}/api/send`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({meta,files})
        });
        fill.style.width='80%';
        const j=await res.json();
        if(!res.ok||!j.success) throw new Error(j.error||`HTTP ${res.status}`);
        fill.style.width='100%';
        setStatus('Sent to the office ✔', 'ok');
        setTimeout(()=>{ bar.style.display='none'; fill.style.width='0%'; }, 800);
        alert('Sent ✅ Thank you! We will get back to you shortly.');
      }catch(e){
        console.error(e);
        setStatus('Send failed: '+(e?.message||e), 'err');
        bar.style.display='none'; fill.style.width='0%';
        alert('Failed to send: '+(e?.message||e));
      }
    });
  </script>
</body>
</html>